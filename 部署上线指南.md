# 项目上线准备清单

## CI/CD可靠性检查

### ✅ 已完成的配置
- [x] Dockerfile使用uv官方镜像
- [x] GitHub Actions工作流已适配新版流程
- [x] SSH部署脚本（自动化推送及回滚支持）
- [x] 健康检查接口 `/health/`
- [x] Docker Compose配置（多服务支持）
- [x] Nginx反向代理配置（含HTTPS自动化）

### 🔍 需要验证的项目

#### 1. GitHub仓库设置
- [ ] 仓库权限与分支保护规则已配置
- [ ] 配置GitHub Secrets（含所有必需环境变量）
- [ ] 启用GitHub Actions（默认启用，需检查权限）

#### 2. 目标服务器准备
- [ ] Linux服务器（Ubuntu 22.04+ 推荐，已安装docker/compose）
- [ ] 服务器公网IP与域名已绑定
- [ ] SSH密钥认证已配置，支持自动化部署

#### 3. 安全配置
- [ ] 生成强SECRET_KEY并存储于环境变量
- [ ] 数据库密码与连接信息已加密管理
- [ ] 防火墙规则已限制仅开放必要端口
- [ ] SSL证书自动化申请与续期（推荐使用Let's Encrypt）

## 项目外准备操作

### 1. 服务器环境准备

```bash
# 购买并配置云服务器（推荐配置）
# - CPU: 2核+
# - 内存: 4GB+
# - 存储: 50GB+
# - 带宽: 5Mbps+

# 获取服务器信息
SSH_HOST="your-server-ip"
SSH_USERNAME="ubuntu"  # 或其他用户名
SSH_PORT="22"
```

### 2. 域名和SSL证书

```bash
# 购买域名（如：yourdomain.com）
# 配置DNS解析到服务器IP

# SSL证书可以通过Let's Encrypt免费获取
# 将在部署时自动配置
```

### 3. GitHub配置

#### 必需Secrets配置：
在GitHub仓库 Settings -> Secrets and variables -> Actions 中添加：

1. `SSH_HOST`: 服务器IP地址
2. `SSH_USERNAME`: SSH用户名
3. `SSH_PRIVATE_KEY`: SSH私钥内容
4. `SSH_PORT`: SSH端口（默认22）

#### 可选Secrets：
5. `DEPLOY_WEBHOOK`: 部署通知Webhook URL
6. `GITHUB_TOKEN`: 已自动生成，无需手动添加

### 4. 生成SSH密钥对

```bash
# 在本地生成SSH密钥对
ssh-keygen -t ed25519 -C "your-email@example.com" -f ~/.ssh/emoguard_deploy

# 将公钥添加到服务器
ssh-copy-id -i ~/.ssh/emoguard_deploy.pub -p 22 username@server-ip

# 私钥内容用于GitHub Secret
cat ~/.ssh/emoguard_deploy
```

### 5. 生成强SECRET_KEY

```bash
# 生成Django SECRET_KEY
python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"

# 或使用openssl
openssl rand -base64 50
```

### 6. 微信小程序配置

```bash
# 在微信公众平台获取：
# - AppID
# - AppSecret

# 配置服务器域名（需要备案）
# 添加你的域名到微信小程序后台
```

## 部署流程验证

### 1. 测试构建
```bash
# 本地测试Docker构建
docker build -t emoguard-test .

# 测试运行
docker run --rm -p 8000:8000 emoguard-test
```

### 2. 测试GitHub Actions
```bash
# 推送代码到master分支触发测试
git push origin master

# 创建标签触发部署
git tag v1.0.0
git push origin v1.0.0
```

### 3. 验证部署
```bash
# 检查服务状态
curl http://your-domain/health/

# 检查API接口
curl http://your-domain/api/
```

## 生产环境优化

### 1. 性能优化
- [ ] 配置Redis缓存
- [ ] 使用Gunicorn替代Django开发服务器
- [ ] 配置CDN加速静态文件
- [ ] 数据库连接池优化

### 2. 监控告警
- [ ] 配置Prometheus监控
- [ ] 设置Grafana仪表盘
- [ ] 配置告警通知（邮件/短信）

### 3. 备份策略
- [ ] 数据库自动备份
- [ ] 文件备份（媒体文件）
- [ ] 备份验证和恢复测试

## 常见问题处理

### 1. 构建失败
- 检查依赖版本兼容性
- 查看GitHub Actions日志
- 验证Dockerfile语法

### 2. 部署失败
- 检查SSH连接配置
- 验证服务器权限
- 查看部署日志：`/var/log/emoguard/deploy.log`

### 3. 服务无法访问
- 检查防火墙设置
- 验证Nginx配置
- 检查域名解析

### 4. 数据库连接失败
- 验证数据库配置
- 检查网络连接
- 查看数据库日志

## 上线前最终检查

### 功能测试
- [ ] 用户注册/登录
- [ ] 量表测试功能
- [ ] 文章浏览
- [ ] 日记记录
- [ ] 报告生成

### 性能测试
- [ ] 并发用户测试
- [ ] 数据库性能测试
- [ ] 接口响应时间测试

### 安全测试
- [ ] SQL注入测试
- [ ] XSS攻击测试
- [ ] CSRF防护测试
- [ ] 权限控制测试

## 联系方式

如有问题，请检查：
1. GitHub Actions日志
2. 服务器日志文件
3. 项目文档和README
4. 提交Issue到项目仓库