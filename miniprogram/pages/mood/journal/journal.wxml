<!--pages/mood/journal/journal.wxml-->
<view class="mood-container gradient-bg">
  <!-- å¿ƒæƒ…è®°å½•æ¨¡å— -->
  <view class="mood-record-section card">
    <view class="history-header" bindtap="toggleHistory">
      <text class="history-title">æƒ…ç»ªè®°å½•</text>
 </view>
    <!-- é¢˜ç›®1ï¼šä¸»è§‚æƒ…ç»ª -->
    <view class="question-block">
      <view class="question-header">
        <text class="question-title">{{questions[0].title}}</text>
        <text class="question-subtitle">{{questions[0].question}}</text>
      </view>
      <view class="question-content">
        <view class="mood-options">
          <view 
            wx:for="{{questions[0].options}}" 
            wx:key="value"
            class="mood-option {{mainMood === item.value ? 'selected' : ''}}"
            bindtap="handleMoodSelect" 
            data-key="mainMood" 
            data-value="{{item.value}}"
          >
            <view class="mood-emoji">{{item.emoji}}</view>
            <text class="mood-text">{{item.text}}</text>
          </view>
        </view>
        <view wx:if="{{mainMood === 'å…¶ä»–'}}" class="other-mood-input">
          <input placeholder="è¯·å¡«å†™å…¶ä»–æƒ…ç»ª" value="{{mainMoodOther}}"
                 data-key="mainMoodOther" bindinput="handleTextChange"/>
        </view>
      </view>
    </view>

    <!-- é¢˜ç›®2ï¼šæƒ…ç»ªå¼ºåº¦ -->
    <view wx:if="{{mainMood}}" class="question-block">
      <view class="question-header">
        <text class="question-title">{{questions[1].title}}</text>
        <text class="question-subtitle">{{questions[1].question}}</text>
      </view>
      <view class="question-content">
        <view class="slider-group">
          <slider
            min="{{questions[1].min}}"
            max="{{questions[1].max}}"
            step="{{questions[1].step}}"
            value="{{moodIntensity}}"
            show-value="true"
            data-key="moodIntensity"
            bindchange="handleSliderChange"
          />
          <text class="slider-value">å½“å‰å¼ºåº¦ï¼š{{moodIntensity}}/10</text>
        </view>
      </view>
    </view>

    <!-- é¢˜ç›®3ï¼šæƒ…ç»ªåŸå›  (å¤šé€‰) -->
    <view wx:if="{{mainMood && moodIntensity !== undefined && moodIntensity !== null}}" class="question-block">
      <view class="question-header">
        <text class="question-title">{{questions[2].title}}</text>
        <text class="question-subtitle">{{questions[2].question}}</text>
      </view>
      <view class="question-content">
        <checkbox-group class="checkbox-group" data-key="moodSupplementTags" bindchange="handleCheckboxChange">
          <label
            wx:for="{{questions[2].options}}"
            wx:key="value"
            class="checkbox-option {{isCheckboxSelected('moodSupplementTags', item.value) ? 'selected' : ''}}"
          >
            <checkbox value="{{item.value}}" checked="{{isCheckboxSelected('moodSupplementTags', item.value)}}" />
            <text class="checkbox-text">{{item.text}}</text>
          </label>
        </checkbox-group>
      </view>
    </view>

    <!-- é¢˜ç›®4ï¼šè¡¥å……è¯´æ˜ (æ–‡æœ¬è¾“å…¥) -->
    <view wx:if="{{moodSupplementTags.length > 0}}" class="question-block">
      <view class="question-header">
        <text class="question-title">{{questions[3].title}}</text>
        <text class="question-subtitle">{{questions[3].question}}</text>
      </view>
      <view class="question-content">
        <textarea
          class="supplement-textarea"
          placeholder="{{questions[3].placeholder}}"
          value="{{moodSupplementText}}"
          bindinput="handleSupplementTextInput"
          maxlength="200"
        />
      </view>
    </view>

    <!-- æäº¤æŒ‰é’® -->
    <view
      wx:if="{{moodSupplementTags.length > 0}}"
      class="submit-mood-btn {{mainMood && moodIntensity > 0 ? '' : 'btn-disabled'}}"
      bindtap="submitMoodRecord"
      hover-class="submit-mood-btn-hover"
      hover-stay-time="150"
    >
      <text class="btn-icon">âœ“</text>
      <text class="btn-text">è®°å½•å¿ƒæƒ…</text>
    </view>
  </view>

  <!-- å¿ƒæƒ…å†å² -->
  <view class="mood-history-section card">
    <view class="history-header" bindtap="toggleHistory">
      <text class="history-title">æƒ…ç»ªå†å²</text>
      <text class="history-count">{{journals.length}}æ¡è®°å½•</text>
      <text class="toggle-icon">{{showHistory ? 'â–²' : 'â–¼'}}</text>
    </view>

    <view wx:if="{{showHistory}}" class="history-content">
      <view wx:if="{{loading}}" class="loading-state">
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>

      <view wx:elif="{{journals.length === 0}}" class="empty-state">
        <text class="empty-icon">ğŸ’­</text>
        <text class="empty-text">è¿˜æ²¡æœ‰å¿ƒæƒ…è®°å½•</text>
        <text class="empty-hint">å®Œæˆä¸Šæ–¹é¢˜ç›®è®°å½•ä½ çš„ç¬¬ä¸€æ¡å¿ƒæƒ…å§</text>
      </view>

      <view wx:else class="history-list">
        <view 
          wx:for="{{journals}}" 
          wx:key="id" 
          class="history-item"
        >
          <view class="item-emoji">{{item.emoji}}</view>
          <view class="item-content">
            <view class="item-header">
              <text class="item-mood-text">{{item.mainMoodText}}</text>
              <text class="item-time">{{formatTime(item.created_at)}}</text>
            </view>
            <view class="item-detail">
                <text wx:if="{{item.text}}" class="item-reason">{{item.text}}</text>
                <text class="item-score">å¼ºåº¦: {{item.mood_score}}/10</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>