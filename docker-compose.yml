services:
  # ----------------------------------------------------
  # 1. Django Backend Service (backend)
  # ----------------------------------------------------
  backend:
    image: __IMAGE__
    container_name: emoguard-backend
    restart: unless-stopped # æ ‡å‡†åŒ–é‡å¯ç­–ç•¥
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Django Secrets and environment variables
      SECRET_KEY: ${SECRET_KEY}
      DJANGO_SUPERUSER_USERNAME: ${DJANGO_SUPERUSER_USERNAME}
      DJANGO_SUPERUSER_EMAIL: ${DJANGO_SUPERUSER_EMAIL}
      DJANGO_SUPERUSER_PASSWORD: ${DJANGO_SUPERUSER_PASSWORD}
      WECHAT_MINI_PROGRAM_APP_ID: ${WECHAT_MINI_PROGRAM_APP_ID}
      WECHAT_MINI_PROGRAM_APP_SECRET: ${WECHAT_MINI_PROGRAM_APP_SECRET}
      
      # Database and Caching URLs (ä½¿ç”¨ service name ä½œä¸º host)
      DATABASE_URL: postgresql://emoguard:${POSTGRES_PASSWORD}@db:5432/emoguard
      CELERY_BROKER_URL: redis://:${REDIS_PASSWORD}@redis:6379/0
      CELERY_RESULT_BACKEND: redis://:${REDIS_PASSWORD}@redis:6379/1
      
      # Timezone and Redis Password for healthcheck/app logic
      TZ: Asia/Shanghai
      REDIS_PASSWORD: ${REDIS_PASSWORD} # ä¼ é€’ç»™åº”ç”¨çš„ç¯å¢ƒå˜é‡

    volumes:
      # ä½¿ç”¨å‘½åå·ï¼Œæ›´æ¨è Docker Compose çš„æ ‡å‡†åšæ³•
      - media_data:/app/media
      - staticfiles_data:/app/staticfiles
    networks:
      - emoguard-net

    # åç«¯å¥åº·æ£€æŸ¥ï¼šç¡®ä¿ Web æœåŠ¡å¯åŠ¨å¹¶å“åº”
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/health"]
      interval: 15s
      timeout: 10s
      retries: 8
      start_period: 30s
      
  # ----------------------------------------------------
  # 2. Celery Worker Service
  # ----------------------------------------------------
  celery-worker:
    image: __IMAGE__
    container_name: emoguard-celery-worker
    restart: unless-stopped 
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # ç¡®ä¿ Worker çŸ¥é“å®ƒæ˜¯ Worker è§’è‰²
      CONTAINER_ROLE: worker 
      SECRET_KEY: ${SECRET_KEY}
      DATABASE_URL: postgresql://emoguard:${POSTGRES_PASSWORD}@db:5432/emoguard
      CELERY_BROKER_URL: redis://:${REDIS_PASSWORD}@redis:6379/0
      CELERY_RESULT_BACKEND: redis://:${REDIS_PASSWORD}@redis:6379/1
      TZ: Asia/Shanghai
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes:
      # å‡è®¾ logs å·ç”¨äº Celery æ—¥å¿—
      - logs_data:/app/logs
    networks:
      - emoguard-net

  # ----------------------------------------------------
  # 3. Celery Beat Service
  # ----------------------------------------------------
  celery-beat:
    image: __IMAGE__
    container_name: emoguard-celery-beat
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # ç¡®ä¿ Beat çŸ¥é“å®ƒæ˜¯ Beat è§’è‰²
      CONTAINER_ROLE: beat
      SECRET_KEY: ${SECRET_KEY}
      DATABASE_URL: postgresql://emoguard:${POSTGRES_PASSWORD}@db:5432/emoguard
      CELERY_BROKER_URL: redis://:${REDIS_PASSWORD}@redis:6379/0
      CELERY_RESULT_BACKEND: redis://:${REDIS_PASSWORD}@redis:6379/1
      TZ: Asia/Shanghai
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes:
      - logs_data:/app/logs # Beat å’Œ Worker å…±äº«æ—¥å¿—å·
    networks:
      - emoguard-net

  # ----------------------------------------------------
  # 4. PostgreSQL Database (db)
  # ----------------------------------------------------
  db:
    image: postgres:15
    container_name: emoguard-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: emoguard
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: emoguard
      TZ: Asia/Shanghai
    volumes:
      # ä½¿ç”¨å‘½åå·æŒä¹…åŒ–æ•°æ®
      - pg_data:/var/lib/postgresql/data
    networks:
      - emoguard-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U emoguard -d emoguard"] # æ˜ç¡®æŒ‡å®šç”¨æˆ·å’Œæ•°æ®åº“ï¼Œæ›´å¥å£®
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s # ç¼©çŸ­å¯åŠ¨æœŸï¼Œ15s åº”è¯¥è¶³å¤Ÿ

  # ----------------------------------------------------
  # 5. Redis Cache/Broker (redis)
  # ----------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: emoguard-redis
    restart: unless-stopped
    # Redis ä¸ä½¿ç”¨ environment è®¾ç½®å¯†ç ï¼Œè€Œæ˜¯é€šè¿‡ command
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD}"]
    volumes:
      # ä½¿ç”¨å‘½åå·æŒä¹…åŒ–æ•°æ®
      - redis_data:/data
    networks:
      - emoguard-net
    # Redis å¥åº·æ£€æŸ¥ï¼šä½¿ç”¨ redis-cli è®¤è¯å¹¶æ‰§è¡Œ PING
    healthcheck:
      test: ["CMD-SHELL", "redis-cli --no-auth-warning -a ${REDIS_PASSWORD} ping | grep PONG"] # ç¡®ä¿è¿”å› PONG
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
      
  # ----------------------------------------------------
  # 6. Nginx Reverse Proxy (New Edge Service)
  # ----------------------------------------------------
  nginx:
    image: nginx:stable-alpine
    container_name: emoguard-nginx
    restart: unless-stopped
    # ğŸŒŸ ç¡®ä¿åªæœ‰åœ¨ backend å®¹å™¨å¥åº·æ—¶æ‰å¯åŠ¨ Nginx ğŸŒŸ
    depends_on:
      backend:
        condition: service_healthy 
    ports:
      - "8080:80" 
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      # ğŸŒŸ æŒ‚è½½åª’ä½“å·å’Œé™æ€æ–‡ä»¶å·ï¼Œä»¥ä¾¿ Nginx ç›´æ¥æä¾›æœåŠ¡ ğŸŒŸ
      - media_data:/app/media:ro 
      - staticfiles_data:/app/staticfiles:ro
    networks:
      - emoguard-net

# ----------------------------------------------------
# Named Volumes and Network Configuration
# ----------------------------------------------------
volumes:
  pg_data:
    name: emoguard_pg_data
  redis_data:
    name: emoguard_redis_data
  media_data:
    name: emoguard_media
  staticfiles_data:
    name: emoguard_staticfiles
  logs_data:
    name: emoguard_logs

networks:
  emoguard-net:
    driver: bridge