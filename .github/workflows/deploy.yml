name: Build & Deploy Backend Stack

on:
  workflow_dispatch:

env:
  IMAGE_BASE_NAME: ghcr.io/${{ github.repository }}/emoguard-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Get Version
      id: get_version
      run: echo "VERSION=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

    - name: Build & Push Backend Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ env.IMAGE_BASE_NAME }}:${{ steps.get_version.outputs.VERSION }}
          ${{ env.IMAGE_BASE_NAME }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
    - name: Render remote .env from GitHub Secrets
      run: |
        ssh -o StrictHostKeyChecking=yes ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        set -euo pipefail

        # 1. ç”Ÿæˆ/è¦†ç›– ~/.envï¼ˆæƒé™ 600ï¼Œä»…å½“å‰ç”¨æˆ·å¯è¯»ï¼‰
        umask 0077
        cat > ~/.env << ENVEOF
        # ===== Postgres =====
        POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
        POSTGRES_USER=${{ secrets.POSTGRES_USER }}
        POSTGRES_DB=${{ secrets.POSTGRES_DB }}

        # ===== Redis =====
        REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}

        # ===== Django =====
        SECRET_KEY=${{ secrets.SECRET_KEY }}
        DJANGO_SUPERUSER_USERNAME=${{ secrets.DJANGO_SUPERUSER_USERNAME }}
        DJANGO_SUPERUSER_EMAIL=${{ secrets.DJANGO_SUPERUSER_EMAIL }}
        DJANGO_SUPERUSER_PASSWORD=${{ secrets.DJANGO_SUPERUSER_PASSWORD }}

        # ===== WeChat Mini-Program =====
        WECHAT_MINI_PROGRAM_APP_ID=${{ secrets.WECHAT_MINI_PROGRAM_APP_ID }}
        WECHAT_MINI_PROGRAM_APP_SECRET=${{ secrets.WECHAT_MINI_PROGRAM_APP_SECRET }}

        # ===== Optional extras =====
        DEBUG=${{ secrets.DEBUG }}
        ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
        SENTRY_DSN=${{ secrets.SENTRY_DSN }}
        ENVEOF

        # 2. ç¡®è®¤å†™å‡ºæˆåŠŸï¼ˆå¯é€‰ï¼Œè°ƒè¯•ç”¨ï¼‰
        echo "âœ… Remote .env ready"
        ls -l ~/.env
        EOF

    - name: Upload Docker Compose File
      run: |
        # ä½¿ç”¨ scp å°†æœ¬åœ°ä»“åº“ä¸­çš„ docker-compose.yml å¤åˆ¶åˆ°è¿œç¨‹æœåŠ¡å™¨çš„å®¶ç›®å½•
        # -o StrictHostKeyChecking=no ç”¨äºé¿å…ç¬¬ä¸€æ¬¡è¿æ¥æ—¶çš„äº¤äº’ç¡®è®¤
        # -i ~/.ssh/id_rsa æŒ‡å®šäº†ç§é’¥è·¯å¾„
        scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa \
          ./docker-compose.yml \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/docker-compose.yml

    - name: Deploy Stack via Docker Compose
      run: |
        VERSION=${{ steps.get_version.outputs.VERSION }}
        REPO="${{ github.repository }}"
        IMAGE="ghcr.io/$REPO/emoguard-backend:$VERSION"
        export REPO
        export VERSION

        # è¿œç¨‹è¿æ¥åˆ°æœåŠ¡å™¨
        ssh -o StrictHostKeyChecking=yes ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << EOF
        set -euo pipefail

        pwd # ç¡®è®¤å½“å‰å·¥ä½œç›®å½•ï¼ˆé»˜è®¤ä¸ºSSHç”¨æˆ·çš„å®¶ç›®å½•ï¼‰

        # å¤‡ä»½ä¸Šä¸€ä¸ªæˆåŠŸçš„é•œåƒ tag
        if [ -f last_successful_version.txt ]; then
          LAST_VERSION=\$(cat last_successful_version.txt)
        else
          LAST_VERSION="latest"
        fi

        echo "ğŸ” Logging into GHCR..."
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

        echo "ğŸ“¦ Pulling latest backend image..."
        docker pull $IMAGE

        echo "ğŸ›‘ Stopping existing stack..."
        docker compose -f docker-compose.yml down || true
        

        echo "ğŸ§¼ Cleaning up unused images..."
        echo "ğŸš€ Updating docker-compose.yml to use version $VERSION..."
        sed -i.bak "/backend:/,/container_name:/s|image:.*emoguard-backend.*|image: $IMAGE|" docker-compose.yml
        sed -i.bak "/celery-worker:/,/container_name:/s|image:.*emoguard-backend.*|image: $IMAGE|" docker-compose.yml
        sed -i.bak "/celery-beat:/,/container_name:/s|image:.*emoguard-backend.*|image: $IMAGE|" docker-compose.yml

        echo "ğŸ“ Ensuring necessary directories ..."
        for d in media logs staticfiles pgdata redisdata; do
          sudo mkdir -p /srv/emoguard/$d
          sudo chown 1000:1000 /srv/emoguard/$d
          sudo chmod 755 /srv/emoguard/$d
        done

        echo "ğŸš€ Starting stack..."
        docker compose -f docker-compose.yml up -d --remove-orphans

        echo "â³ Waiting for backend health..."
        HEALTH_RETRIES=10
        HEALTH_INTERVAL=3
        for i in \$(seq 1 \$HEALTH_RETRIES); do
          if docker exec emoguard-backend curl -fs http://localhost:8000/health/ > /dev/null; then
            echo "âœ… Backend healthy"
            echo "$VERSION" > last_successful_version.txt
            exit 0
          fi
          echo " Â âŒ› Health check retry \$i..."
          sleep \$HEALTH_INTERVAL
        done

        echo "âŒ Health check failed"
        echo "ğŸ“œ Recent backend logs:"
        docker compose logs backend --tail 50

        echo "â™»ï¸ Rolling back to last successful version: \$LAST_VERSION"
        # å›æ»šæ—¶åŒæ ·åªæ›¿æ¢ backend æœåŠ¡é•œåƒ
        sed -i.bak "/backend:/,/container_name:/s|image:.*emoguard-backend.*|image: ${{ env.IMAGE_BASE_NAME }}:\$LAST_VERSION|" docker-compose.yml
        docker compose down
        docker compose up -d --remove-orphans

        exit 1 
        EOF
    - name: âœ… Deployment Finished
      run: echo "ğŸš€ Deploy OK â€” version ${{ steps.get_version.outputs.VERSION }}"
