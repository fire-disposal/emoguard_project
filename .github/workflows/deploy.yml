name: Build & Deploy Backend

on:
  workflow_dispatch:

env:
  IMAGE_BASE_NAME: ghcr.io/${{ github.repository }}/emoguard-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Get Version
      id: get_version
      run: echo "VERSION=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

    - name: Build & Push
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ env.IMAGE_BASE_NAME }}:${{ steps.get_version.outputs.VERSION }}
          ${{ env.IMAGE_BASE_NAME }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to Server
      run: |
        VERSION=${{ steps.get_version.outputs.VERSION }}
        IMAGE="${{ env.IMAGE_BASE_NAME }}:$VERSION"

        ssh -o StrictHostKeyChecking=yes ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        set -euo pipefail
        
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        IMAGE="${{ env.IMAGE_BASE_NAME }}:$VERSION"
        
        echo "üîê Logging into GHCR..."
        echo "${{ secrets.GHCR_PAT_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin
        
        echo "üì¶ Pulling new image..."
        docker pull $IMAGE || { echo "‚ùå Pull failed"; exit 1; }

        echo "üõë Stopping previous container (if exists)..."
        docker stop emoguard-backend || true
        docker rm emoguard-backend || true

        echo "üöÄ Starting new container..."
        docker run -d \
          --name emoguard-backend \
          --network backend_net \
          --restart unless-stopped \
          -p 8000:8000 \
          -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
          -e SECRET_KEY="${{ secrets.SECRET_KEY }}" \
          -e WECHAT_MINI_PROGRAM_APP_ID="${{ secrets.WECHAT_MINI_PROGRAM_APP_ID }}" \
          -e WECHAT_MINI_PROGRAM_APP_SECRET="${{ secrets.WECHAT_MINI_PROGRAM_APP_SECRET }}" \
          -v /srv/emoguard/media:/app/media \
          -v /srv/emoguard/logs:/app/logs \
          -v /srv/emoguard/staticfiles:/app/staticfiles \
          --health-cmd "curl -f http://localhost:8000/health || exit 1" \
          --health-interval=10s --health-timeout=5s --health-retries=5 \
          $IMAGE

        echo "‚è≥ Waiting for service to come up..."
        for i in {1..10}; do
          if curl -fs http://localhost:8000/health/ > /dev/null; then
            echo "‚úÖ Service healthy"
            sleep 2
            exit 0
          fi
          echo "  ‚åõ Health check retry \$i..."
          sleep 3
        done

        echo "‚ùå Health check failed"
        echo "üìú Recent logs:"
        docker logs emoguard-backend --tail 50

        echo "‚ôªÔ∏è Rolling back to previous image..."
        docker stop emoguard-backend || true
        docker rm emoguard-backend || true
        docker run -d --name emoguard-backend --restart unless-stopped \
          -p 8000:8000 \
          -v /srv/emoguard/media:/app/media \
          -v /srv/emoguard/logs:/app/logs \
          -v /srv/emoguard/staticfiles:/app/staticfiles \
          ${{ env.IMAGE_BASE_NAME }}:latest

        exit 1
        EOF

    - name: ‚úÖ Deployment Finished
      run: echo "üöÄ Deploy OK ‚Äî version ${{ steps.get_version.outputs.VERSION }}"
