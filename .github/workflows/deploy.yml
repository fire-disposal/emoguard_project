name: Build & Deploy Backend Stack

on:
  # ä½¿ç”¨ workflow_dispatch å…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿è°ƒè¯•
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual deploy'

env:
  # å®šä¹‰é•œåƒçš„åŸºç¡€è·¯å¾„
  IMAGE_BASE: ghcr.io/${{ github.repository }}/emoguard-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev # éƒ¨ç½²çŽ¯å¢ƒåç§°
    permissions:
      contents: read
      packages: write # å†™å…¥ GHCR

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Version Tag
        id: ver
        run: |
          set -euo pipefail
          # æˆªå– SHA å‰ 8 ä½ä½œä¸ºæ ‡ç­¾ï¼Œä½œä¸ºéƒ¨ç½²ç‰ˆæœ¬
          TAG_SHORT=$(echo "${GITHUB_SHA:0:8}")
          TAG_FINAL="${TAG_SHORT:-latest}" 
          # è¾“å‡ºå®Œæ•´çš„é•œåƒåœ°å€å’Œæ ‡ç­¾
          echo "IMAGE=${{ env.IMAGE_BASE }}:$TAG_FINAL" >> $GITHUB_OUTPUT
          echo "TAG=$TAG_FINAL" >> $GITHUB_OUTPUT # æ–¹ä¾¿åŽç»­æ­¥éª¤å¼•ç”¨

      - name: Build & Push Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ steps.ver.outputs.IMAGE }} # SHA tag
            ${{ env.IMAGE_BASE }}:latest # latest tag
          # å¯ç”¨ GitHub Actions ç¼“å­˜ï¼ŒåŠ é€Ÿæž„å»º
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Setup SSH Key
        # æ‰‹åŠ¨åˆ›å»º SSH ç§é’¥æ–‡ä»¶ï¼Œç”¨äºŽ scp å’Œ ssh
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # é…ç½® SSH å®¢æˆ·ç«¯ï¼šç¦ç”¨ä¸¥æ ¼ä¸»æœºå¯†é’¥æ£€æŸ¥ï¼Œæé«˜ CI/CD ç¨³å®šæ€§
          echo -e "Host *\n  StrictHostKeyChecking no\n  UserKnownHostsFile /dev/null" >> ~/.ssh/config

      - name: Render & Upload Stack Files
        run: |
          set -euo pipefail
          
          # 1. æ¸²æŸ“ docker-compose.yml æ–‡ä»¶ï¼Œæ›¿æ¢é•œåƒå ä½ç¬¦
          # ä½¿ç”¨æ­¥éª¤è¾“å‡ºçš„å®Œæ•´ IMAGE å˜é‡
          sed "s|__IMAGE__|${{ steps.ver.outputs.IMAGE }}|g" \
            docker-compose.yml > docker-compose.rendered.yml

          # 2. ç”Ÿæˆ .env æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰æ•æ„Ÿé…ç½®
          cat > .env <<EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DJANGO_SUPERUSER_USERNAME=${{ secrets.DJANGO_SUPERUSER_USERNAME }}
          DJANGO_SUPERUSER_EMAIL=${{ secrets.DJANGO_SUPERUSER_EMAIL }}
          DJANGO_SUPERUSER_PASSWORD=${{ secrets.DJANGO_SUPERUSER_PASSWORD }}
          WECHAT_MINI_PROGRAM_APP_ID=${{ secrets.WECHAT_MINI_PROGRAM_APP_ID }}
          WECHAT_MINI_PROGRAM_APP_SECRET=${{ secrets.WECHAT_MINI_PROGRAM_APP_SECRET }}
          COMPOSE_BAKE=true
          EOF

          # 3. ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼ˆæ”¾ç½®åœ¨ç”¨æˆ·ä¸»ç›®å½•ï¼‰
          echo "ðŸ“¤ Uploading files to server..."
          scp -i ~/.ssh/id_rsa docker-compose.rendered.yml \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/docker-compose.yml
          scp -i ~/.ssh/id_rsa .env \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/.env

      - name: Deploy Stack via SSH
        run: |
          # SSH è¿žæŽ¥åˆ°æœåŠ¡å™¨å¹¶æ‰§è¡Œéƒ¨ç½²å‘½ä»¤
          # ç¡®ä¿ EOF æ ‡è®°ä¸Ž ssh å‘½ä»¤åœ¨ run: | å—å†…å¯¹é½ã€‚
          ssh -i ~/.ssh/id_rsa -T ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            # ç»Ÿä¸€å…³é”®è„šæœ¬ï¼Œä»»ä½•éžé›¶é€€å‡ºç éƒ½å°†ç»ˆæ­¢è„šæœ¬
            set -euo pipefail

            # ç™»å½• & æ‹‰é•œåƒ
            echo "ðŸ”‘ Dockerç™»å½•..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            echo "ðŸ“¥ æ‹‰å–é•œåƒ..."
            # ä½¿ç”¨ ~/docker-compose.yml å’Œ ~/.env
            docker compose -f ~/docker-compose.yml --env-file ~/.env pull
            
            echo "ðŸ” éªŒè¯é•œåƒ:"
            docker images | grep emoguard || echo "âš ï¸ æœªæ‰¾åˆ°emoguardé•œåƒ"

            # åœæ­¢æ—§å®¹å™¨å¹¶æ¸…ç†å­¤ç«‹å®¹å™¨
            echo "ðŸš€ åœæ­¢æ—§å®¹å™¨..."
            docker compose -f ~/docker-compose.yml --env-file ~/.env down --remove-orphans
            
            # å¯åŠ¨æ–°å®¹å™¨
            echo "ðŸš€ å¯åŠ¨æ–°å®¹å™¨..."
            docker compose -f ~/docker-compose.yml --env-file ~/.env up -d
            
            echo "â³ ç­‰å¾…å®¹å™¨åˆå§‹åŒ–..."
            sleep 10
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            echo "ðŸ“‹ æ£€æŸ¥å®¹å™¨çŠ¶æ€:"
            docker ps -a | grep emoguard || true

            echo "ðŸ“‹ æ£€æŸ¥ç«¯å£ç›‘å¬:"
            ss -tlnp | grep :8000 || true

            # å¥åº·æ£€æŸ¥ï¼šç­‰å¾…åŽç«¯åº”ç”¨å¯åŠ¨å¹¶å“åº”
            echo "ðŸ” å¼€å§‹å¥åº·æ£€æŸ¥ (Max 20 attempts, 5s interval)..."
            health_check_passed=false
            for i in {1..20}; do
              # ä»Žå®¿ä¸»æœºå†…éƒ¨æ‰§è¡Œ curl æ£€æŸ¥åŽç«¯å®¹å™¨çš„å¥åº·ç«¯ç‚¹
              if docker exec emoguard-backend curl -fsS http://localhost:8000/health; then
                echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
                health_check_passed=true
                break
              fi
              echo "â³ Health check $i/20 failed, waiting 5 seconds..."
              
              # å®šæœŸæ‰“å°è¯Šæ–­ä¿¡æ¯
              if [ $i -eq 5 ] || [ $i -eq 10 ] || [ $i -eq 15 ]; then
                echo "--- è¯Šæ–­ä¿¡æ¯ ---"
                docker ps -a | grep emoguard
                docker compose logs backend --tail 20
                echo "----------------"
              fi
              sleep 5
            done

            if [ "$health_check_passed" != "true" ]; then
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œæ”¶é›†æœ€ç»ˆè¯Šæ–­ä¿¡æ¯:"
              docker ps -a
              docker compose logs backend --tail 50
              docker compose logs db --tail 20
              docker compose logs redis --tail 20
              exit 1
            fi

            # è®°å½•ç‰ˆæœ¬å¹¶å®Œæˆ
            echo "${GITHUB_SHA:0:8}" > ~/last_successful_version.txt
            echo "âœ… Deploy OK â€” Image Tag: ${{ steps.ver.outputs.TAG }}"
          EOF
      - name: âœ… Finish Deployment
        run: "echo \"ðŸš€ Deploy finished â€” Image: ${{ steps.ver.outputs.IMAGE }}\""