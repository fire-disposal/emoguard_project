name: Build & Deploy Backend Stack

on:
  workflow_dispatch:

env:
  IMAGE_BASE: ghcr.io/${{ github.repository }}/emoguard-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Version
        id: ver
        # ç»Ÿä¸€å…³é”®è„šæœ¬ set -euo pipefail
        run: |
          set -euo pipefail
          # 1. ä¿®æ­£é•œåƒ tag æ¸²æŸ“ä¸º shell è¯­æ³• `${GITHUB_SHA:-latest}`ï¼Œå¹¶æˆªå–å‰ 8 ä½ SHA
          # ä½¿ç”¨ shell å‚æ•°æ‰©å±•ï¼Œç¡®ä¿å˜é‡å®‰å…¨ï¼Œå¦‚æžœ GITHUB_SHA ä¸ºç©ºï¼Œåˆ™é»˜è®¤ä¸º latest
          TAG_SHORT=$(echo "${GITHUB_SHA:0:8}")
          TAG_FINAL="${TAG_SHORT:-latest}"
          echo "IMAGE=${{ env.IMAGE_BASE }}:$TAG_FINAL" >> $GITHUB_OUTPUT

      - name: Build & Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ steps.ver.outputs.IMAGE }}
            ${{ env.IMAGE_BASE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Setup SSH
        # ç»Ÿä¸€å…³é”®è„šæœ¬ set -euo pipefail
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # ç¦ç”¨ä¸¥æ ¼ä¸»æœºå¯†é’¥æ£€æŸ¥ä»¥æé«˜CI/CDç¨³å®šæ€§
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
          echo "UserKnownHostsFile /dev/null" >> ~/.ssh/config

      - name: Render & Upload stack files
        # ç»Ÿä¸€å…³é”®è„šæœ¬ set -euo pipefail
        run: |
          set -euo pipefail
          # 1. æ¸²æŸ“ composeï¼ˆå”¯ä¸€å ä½ç¬¦ __IMAGE__ï¼‰
          sed "s|__IMAGE__|${{ steps.ver.outputs.IMAGE }}|g" \
            docker-compose.yml > docker-compose.rendered.yml

          # 2. æ¸²æŸ“ .env
          cat > .env <<EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DJANGO_SUPERUSER_USERNAME=${{ secrets.DJANGO_SUPERUSER_USERNAME }}
          DJANGO_SUPERUSER_EMAIL=${{ secrets.DJANGO_SUPERUSER_EMAIL }}
          DJANGO_SUPERUSER_PASSWORD=${{ secrets.DJANGO_SUPERUSER_PASSWORD }}
          WECHAT_MINI_PROGRAM_APP_ID=${{ secrets.WECHAT_MINI_PROGRAM_APP_ID }}
          WECHAT_MINI_PROGRAM_APP_SECRET=${{ secrets.WECHAT_MINI_PROGRAM_APP_SECRET }}
          COMPOSE_BAKE=true
          EOF

          # 3. ä¸Šä¼ åˆ°æœåŠ¡å™¨
          scp -i ~/.ssh/id_rsa \
            docker-compose.rendered.yml \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/docker-compose.yml
          scp -i ~/.ssh/id_rsa \
            .env \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/.env

      - name: Deploy stack
        run: |
          ssh -i ~/.ssh/id_rsa -T -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            # 5. ç»Ÿä¸€å…³é”®è„šæœ¬ set -euo pipefail
            set -euo pipefail

            # ç™»å½• & æ‹‰é•œåƒ
            echo "ðŸ”‘ Dockerç™»å½•..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            echo "ðŸ“¥ æ‹‰å–é•œåƒ..."
            docker compose -f ~/docker-compose.yml pull
            
            echo "ðŸ” éªŒè¯é•œåƒ:"
            docker images | grep emoguard || echo "âš ï¸ æœªæ‰¾åˆ°emoguardé•œåƒ"

            # ç›®å½•æƒé™
            echo "ðŸ“ åˆ›å»ºç›®å½•ç»“æž„..."
            sudo mkdir -p /srv/emoguard/{media,logs,staticfiles,pgdata,redisdata}
            sudo chown -R 1000:1000 /srv/emoguard
            sudo chmod -R 755 /srv/emoguard
            
            echo "ðŸ“‹ ç›®å½•æƒé™æ£€æŸ¥:"
            ls -la /srv/emoguard/ || true

            # å¯åŠ¨
            echo "ðŸš€ åœæ­¢æ—§å®¹å™¨..."
            docker compose -f ~/docker-compose.yml down --remove-orphans
            
            echo "ðŸš€ å¯åŠ¨æ–°å®¹å™¨..."
            docker compose -f ~/docker-compose.yml up -d
            
            echo "â³ ç­‰å¾…å®¹å™¨åˆå§‹åŒ–..."
            sleep 10
            
            echo "ðŸ“‹ æ£€æŸ¥å®¹å™¨çŠ¶æ€:"
            docker ps -a | grep emoguard || true
            
            echo "ðŸ“‹ æ£€æŸ¥ç«¯å£ç›‘å¬:"
            # 3. å°†ç«¯å£ç›‘å¬æ£€æŸ¥ç»Ÿä¸€æ”¹ä¸º ss -tlnp | grep :8000 || true
            ss -tlnp | grep :8000 || true

            # å¥åº·æ£€æŸ¥
            echo "ðŸ” å¼€å§‹å¥åº·æ£€æŸ¥..."
            # 4. å¥åº·æ£€æŸ¥é‡è¯•æ¬¡æ•°ä¸Žé—´éš”è°ƒæ•´ä¸º 20 æ¬¡ï¼Œæ¯æ¬¡ 5 ç§’
            for i in {1..20}; do
              if docker exec emoguard-backend curl -fsS http://localhost:8000/health; then
                echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
                break
              fi
              echo "â³ health check $i/20 failed, waiting..."
              if [ $i -eq 5 ] || [ $i -eq 10 ] || [ $i -eq 15 ]; then
                echo "ðŸ“‹ å®¹å™¨çŠ¶æ€:"
                docker ps -a | grep emoguard
                echo "ðŸ“‹ æœ€è¿‘æ—¥å¿—:"
                docker compose logs backend --tail 20
              fi
              sleep 5
            done || {
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œæ”¶é›†è¯Šæ–­ä¿¡æ¯:"
              docker ps -a
              docker compose logs backend --tail 50
              docker compose logs db --tail 20
              docker compose logs redis --tail 20
              exit 1
            }

            # è®°å½•ç‰ˆæœ¬
            echo "${GITHUB_SHA:0:8}" > ~/last_successful_version.txt
            echo "âœ… Deploy OK â€” ${{ steps.ver.outputs.IMAGE }}"
          EOF

      - name: âœ… Finish
        run: echo "ðŸš€ Deploy finished â€” ${{ steps.ver.outputs.IMAGE }}"