name: Build & Deploy Backend

on:
  workflow_dispatch:

env:
  IMAGE_BASE_NAME: ghcr.io/${{ github.repository }}/emoguard-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Get version
      id: get_version
      run: echo "VERSION=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

    - name: Build & Push
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ env.IMAGE_BASE_NAME }}:${{ steps.get_version.outputs.VERSION }}
          ${{ env.IMAGE_BASE_NAME }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy
      run: |
        VERSION=${{ steps.get_version.outputs.VERSION }}
        IMAGE="${{ env.IMAGE_BASE_NAME }}:$VERSION"

        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} <<EOF
        set -e
        docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} -p ${{ secrets.GHCR_PAT_TOKEN }}

        docker stop emoguard-backend || true
        docker rm emoguard-backend || true

        docker pull \$IMAGE
        docker logout ghcr.io

        docker run -d \
          --name emoguard-backend \
          --restart unless-stopped \
          -p 8000:8000 \
          -e DATABASE_URL=${{ secrets.DATABASE_URL }} \
          -e SECRET_KEY=${{ secrets.SECRET_KEY }} \
          -e WECHAT_MINI_PROGRAM_APP_ID=${{ secrets.WECHAT_MINI_PROGRAM_APP_ID }} \
          -e WECHAT_MINI_PROGRAM_APP_SECRET=${{ secrets.WECHAT_MINI_PROGRAM_APP_SECRET }} \
          -v /srv/emoguard/media:/app/media \
          -v /srv/emoguard/logs:/app/logs \
          -v /srv/emoguard/staticfiles:/app/staticfiles \
          \$IMAGE

        sleep 10
        docker ps | grep emoguard-backend
        EOF

    - name: Done
      run: 'echo ðŸš€ Deploy complete: ${{ steps.get_version.outputs.VERSION }}'
