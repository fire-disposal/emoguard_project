name: Build and Deploy to Server using GHCR (Private)

on:
  workflow_dispatch:

env:
  IMAGE_BASE_NAME: ghcr.io/${{ github.repository }}/emoguard-backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: dev    
    permissions:
      contents: read
      packages: write
      
    env:
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
      GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
      GHCR_PAT_TOKEN: ${{ secrets.GHCR_PAT_TOKEN }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GitHub Container Registry (for PUSH)
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Build and push Docker image to GHCR
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ env.IMAGE_BASE_NAME }}:${{ steps.get_version.outputs.VERSION }}
          ${{ env.IMAGE_BASE_NAME }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ env.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to server
      run: |
        FULL_IMAGE_TAG=${{ env.IMAGE_BASE_NAME }}:${{ steps.get_version.outputs.VERSION }}
        
        ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
        set -e
        
        # ğŸ”‘ ç™»å½• GHCRï¼šä½¿ç”¨ä¼ å…¥çš„ç”¨æˆ·åå’Œ PAT Token
        echo "ğŸ”‘ ç™»å½• GHCR..."
        docker login ghcr.io -u ${{ env.GHCR_USERNAME }} -p ${{ env.GHCR_PAT_TOKEN }}
        
        echo "ğŸ”„ åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨..."
        docker stop emoguard-backend 2>/dev/null || true
        docker rm emoguard-backend 2>/dev/null || true
        
        echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
        docker pull $FULL_IMAGE_TAG
        
        # âš ï¸ é€€å‡ºç™»å½•
        docker logout ghcr.io
        
        echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨..."
        docker run -d \
          --name emoguard-backend \
          --restart unless-stopped \
          -p 8000:8000 \
          --env-file /opt/emoguard/.env \
          -v /opt/emoguard/media:/app/media \
          -v /opt/emoguard/logs:/app/logs \
          -v /opt/emoguard/staticfiles:/app/staticfiles \
          --health-cmd "python -c 'import requests; requests.get(\"http://localhost:8000/health/\", timeout=10)'" \
          --health-interval=30s \
          --health-timeout=10s \
          --health-retries=3 \
          $FULL_IMAGE_TAG
        
        echo "â³ ç­‰å¾…å®¹å™¨å¯åŠ¨..."
        sleep 15
        
        # æ£€æŸ¥å®¹å™¨çŠ¶æ€
        if docker ps | grep -q emoguard-backend; then
          echo "âœ… å®¹å™¨å¯åŠ¨æˆåŠŸ"
          
          # æ£€æŸ¥å¥åº·çŠ¶æ€
          echo "ğŸ¥ æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€..."
          if curl -f http://localhost:8000/health/ > /dev/null 2>&1; then
            echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âš ï¸ åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—:"
            docker logs emoguard-backend --tail 50
            exit 1
          fi
        else
          echo "âŒ å®¹å™¨å¯åŠ¨å¤±è´¥"
          docker logs emoguard-backend --tail 50
          exit 1
        fi
        
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
        echo "ğŸ“‹ å®¹å™¨ä¿¡æ¯:"
        docker ps | grep emoguard-backend
        
        ENDSSH

    - name: Deployment notification
      if: success()
      run: |
        echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
        echo "ğŸ¯ ç‰ˆæœ¬: ${{ steps.get_version.outputs.VERSION }}"
        echo "ğŸ”— åº”ç”¨åœ°å€: http://${{ env.SERVER_HOST }}:8000"
        echo "ğŸ¥ å¥åº·æ£€æŸ¥: http://${{ env.SERVER_HOST }}:8000/health/"

    - name: Cleanup SSH
      if: always()
      run: rm -f ~/.ssh/id_rsa