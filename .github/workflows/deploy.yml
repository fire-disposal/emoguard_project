name: Build & Deploy Backend Stack

on:
  workflow_dispatch:

env:
  IMAGE_BASE: ghcr.io/${{ github.repository }}/emoguard-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Version
        id: ver
        run: echo "IMAGE=${{ env.IMAGE_BASE }}:${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Build & Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ steps.ver.outputs.IMAGE }}
            ${{ env.IMAGE_BASE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Render & Upload stack files
        run: |
          # 1. æ¸²æŸ“ composeï¼ˆå”¯ä¸€å ä½ç¬¦ __IMAGE__ï¼‰
          sed "s|__IMAGE__|${{ steps.ver.outputs.IMAGE }}|g" \
              docker-compose.yml > docker-compose.rendered.yml

          # 2. æ¸²æŸ“ .env
          cat > .env <<EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DJANGO_SUPERUSER_USERNAME=${{ secrets.DJANGO_SUPERUSER_USERNAME }}
          DJANGO_SUPERUSER_EMAIL=${{ secrets.DJANGO_SUPERUSER_EMAIL }}
          DJANGO_SUPERUSER_PASSWORD=${{ secrets.DJANGO_SUPERUSER_PASSWORD }}
          WECHAT_MINI_PROGRAM_APP_ID=${{ secrets.WECHAT_MINI_PROGRAM_APP_ID }}
          WECHAT_MINI_PROGRAM_APP_SECRET=${{ secrets.WECHAT_MINI_PROGRAM_APP_SECRET }}
          DEBUG=${{ secrets.DEBUG }}
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
          SENTRY_DSN=${{ secrets.SENTRY_DSN }}
          EOF

          # 3. ä¸Šä¼ åˆ°æœåŠ¡å™¨
          scp -i ~/.ssh/id_rsa \
              docker-compose.rendered.yml \
              ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/docker-compose.yml
          scp -i ~/.ssh/id_rsa \
              .env \
              ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/.env

      - name: Deploy stack
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -euo pipefail

            # ç™»å½• & æ‹‰é•œåƒ
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker compose -f ~/docker-compose.yml pull

            # ç›®å½•æƒé™
            sudo mkdir -p /srv/emoguard/{media,logs,staticfiles,pgdata,redisdata}
            sudo chown -R 1000:1000 /srv/emoguard
            sudo chmod -R 755 /srv/emoguard

            # å¯åŠ¨
            docker compose -f ~/docker-compose.yml down --remove-orphans
            docker compose -f ~/docker-compose.yml up -d

            # å¥åº·æ£€æŸ¥
            for i in {1..10}; do
              docker exec emoguard-backend curl -fsS http://localhost:8000/health && break
              echo "â³ health check $i..."
              sleep 3
            done || { docker compose logs backend --tail 30; exit 1; }

            # è®°å½•ç‰ˆæœ¬
            echo "${GITHUB_SHA::8}" > ~/last_successful_version.txt
            echo "âœ… Deploy OK â€” ${{ steps.ver.outputs.IMAGE }}"
          EOF

      - name: âœ… Finish
        run: echo "ðŸš€ Deploy finished â€” ${{ steps.ver.outputs.IMAGE }}"