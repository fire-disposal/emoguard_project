name: Build & Deploy Backend Stack

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual deploy'

env:
  IMAGE_BASE: ghcr.io/${{ github.repository }}/emoguard-backend
  DEPLOY_ROOT: /var/www/emoguard



jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Version Tag
        id: ver
        run: |
          set -euo pipefail
          TAG_SHORT=$(echo "${GITHUB_SHA:0:8}")
          TAG_FINAL="${TAG_SHORT:-latest}" 
          echo "IMAGE=${{ env.IMAGE_BASE }}:$TAG_FINAL" >> $GITHUB_OUTPUT
          echo "TAG=$TAG_FINAL" >> $GITHUB_OUTPUT

      - name: Build & Push Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ steps.ver.outputs.IMAGE }}
            ${{ env.IMAGE_BASE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Setup SSH Key
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo -e "Host *\n  StrictHostKeyChecking no\n  UserKnownHostsFile /dev/null" >> ~/.ssh/config

      - name: Render & Upload Stack Files
        run: |
          set -euo pipefail
          
          sed "s|__IMAGE__|${{ steps.ver.outputs.IMAGE }}|g" \
            docker-compose.yml > docker-compose.rendered.yml

          cat > .env <<EOF
          HOST_APP_ROOT=${{ env.DEPLOY_ROOT }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DJANGO_SUPERUSER_USERNAME=${{ secrets.DJANGO_SUPERUSER_USERNAME }}
          DJANGO_SUPERUSER_EMAIL=${{ secrets.DJANGO_SUPERUSER_EMAIL }}
          DJANGO_SUPERUSER_PASSWORD=${{ secrets.DJANGO_SUPERUSER_PASSWORD }}
          WECHAT_MINI_PROGRAM_APP_ID=${{ secrets.WECHAT_MINI_PROGRAM_APP_ID }}
          WECHAT_MINI_PROGRAM_APP_SECRET=${{ secrets.WECHAT_MINI_PROGRAM_APP_SECRET }}
          WECHAT_SUBSCRIPTION_TEMPLATES=${{ secrets.WECHAT_SUBSCRIPTION_TEMPLATES }}
          COMPOSE_BAKE=true
          EOF

          echo "ðŸ“¤ Uploading files to server..."
          scp -i ~/.ssh/id_rsa docker-compose.rendered.yml \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/docker-compose.yml
          scp -i ~/.ssh/id_rsa .env \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/.env

      - name: Deploy Stack via SSH
        shell: bash
        run: |
          ssh -i ~/.ssh/id_rsa -T ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -euo pipefail

            echo "ðŸ”‘ Dockerç™»å½•..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            echo "ðŸ“¥ æ‹‰å–é•œåƒ..."
            docker compose -f ~/docker-compose.yml --env-file ~/.env pull
            
            echo "ðŸ“‚ ç¡®ä¿æŒ‚è½½ç›®å½•å­˜åœ¨å¹¶è®¾ç½®æƒé™..."
            # å°è¯•åˆ›å»ºæ ‡å‡†ç›®å½•ï¼Œå¦‚æžœå¤±è´¥åˆ™è¾“å‡ºæŒ‡å¯¼ä¿¡æ¯
            if sudo mkdir -p ${{ env.DEPLOY_ROOT }}/media ${{ env.DEPLOY_ROOT }}/staticfiles ${{ env.DEPLOY_ROOT }}/logs; then
                echo "âœ… ç›®å½•å·²å°±ç»ª: ${{ env.DEPLOY_ROOT }}"
                # è®¾ç½®æƒé™ç»™å½“å‰ç”¨æˆ·æˆ– docker ç”¨æˆ· (é€šå¸¸ uid 1000)
                sudo chown -R 1000:1000 ${{ env.DEPLOY_ROOT }} || echo "âš ï¸ æ— æ³•è®¾ç½®chownï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨ä»‹å…¥"
                sudo chmod -R 775 ${{ env.DEPLOY_ROOT }} || echo "âš ï¸ æ— æ³•è®¾ç½®chmod"
            else
                echo "âŒ æ— æ³•åˆ›å»ºç›®å½• ${{ env.DEPLOY_ROOT }}ã€‚"
                echo "ðŸ‘‰ è¯·ç™»å½•æœåŠ¡å™¨æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š"
                echo "   sudo mkdir -p ${{ env.DEPLOY_ROOT }}/media ${{ env.DEPLOY_ROOT }}/staticfiles ${{ env.DEPLOY_ROOT }}/logs"
                echo "   sudo chown -R 1000:1000 ${{ env.DEPLOY_ROOT }}"
                echo "   sudo chmod -R 775 ${{ env.DEPLOY_ROOT }}"
                exit 1
            fi
            
            echo "ï¿½ðŸ” éªŒè¯é•œåƒ:"
            docker images | grep emoguard || echo "âš ï¸ æœªæ‰¾åˆ°emoguardé•œåƒ"

            echo "ðŸš€ åœæ­¢æ—§å®¹å™¨..."
            docker compose -f ~/docker-compose.yml --env-file ~/.env down --remove-orphans
            
            echo "ðŸš€ å¯åŠ¨æ–°å®¹å™¨..."
            docker compose -f ~/docker-compose.yml --env-file ~/.env up -d
            
            echo "â³ ç­‰å¾…å®¹å™¨åˆå§‹åŒ–..."
            sleep 10
            
            echo "ðŸ“‹ æ£€æŸ¥å®¹å™¨çŠ¶æ€:"
            docker ps -a | grep emoguard || true

            echo "ðŸ“‹ æ£€æŸ¥ç«¯å£ç›‘å¬:"
            ss -tlnp | grep :8000 || true

            echo "ðŸ” å¼€å§‹å¥åº·æ£€æŸ¥ (Max 20 attempts, 5s interval)..."
            health_check_passed=false
            for i in {1..20}; do
              if docker exec emoguard-backend curl -fsS http://localhost:8000/health; then
                echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
                health_check_passed=true
                break
              fi
              echo "â³ Health check $i/20 failed, waiting 5 seconds..."
              if [ $i -eq 5 ] || [ $i -eq 10 ] || [ $i -eq 15 ]; then
                echo "--- è¯Šæ–­ä¿¡æ¯ ---"
                docker ps -a | grep emoguard
                docker compose logs backend --tail 50
                echo "----------------"
              fi
              sleep 5
            done

            if [ "$health_check_passed" != "true" ]; then
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œæ”¶é›†æœ€ç»ˆè¯Šæ–­ä¿¡æ¯:"
              docker ps -a
              docker compose logs backend --tail 50
              docker compose logs db --tail 20
              docker compose logs redis --tail 20
              exit 1
            fi
            
            echo "ðŸ“¦ è®°å½•æˆåŠŸéƒ¨ç½²çš„ç‰ˆæœ¬..."
            echo "${{ steps.ver.outputs.TAG }}" > ~/last_successful_version.txt
            echo "âœ… Deploy OK"
          EOF
      - name: âœ… Finish Deployment
        run: "echo \"ðŸš€ Deploy finished â€” Image: ${{ steps.ver.outputs.IMAGE }}\""